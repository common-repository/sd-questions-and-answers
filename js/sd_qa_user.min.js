function sd_qa(){$=jQuery;this.add_tab=function(b,a,c){var d=b+"_"+Math.round((Math.random()*100),0);$(".sd_qa_tabs",this.settings.div_selector).append('<div class="ui-tabs-hide '+b+' tab" id="'+d+'">'+c+"</a></div>");this.settings.$tabs.tabs("add","#"+d,a);return $(".sd_qa_tabs #"+d,this.settings.div_selector)};this.answer_question=function(a){var c=this;$("body").css("overflow","hidden");$dialog=$("<div />").dialog({beforeClose:function(){$(this).empty();$("body").css("overflow","auto")},height:"auto",modal:false,position:["center","top"],resizable:true,title:c.settings.strings.answering_a_question,width:500});$dialog.parent().parent().addClass("sd_qa");var b=jQuery.extend(true,{},this.ajaxoptions);b.type="edit_answer";b.question_id=a;b.guest_id=this.settings.guest_id;b.nonce_guest=this.settings.nonce_guest;var c=this;$.post(this.ajaxurl,b,function(g){try{result=c.parseJSON(g);$dialog.html(result.html);var f=$(".send_answer",$dialog);var d=$(".answer_text",$dialog);d.focus();f.click(function(){b.type="send_answer";b.answer_text=d.val();c.set_busy(d);f.attr("disabled",true).fadeTo(100,0.5);$.post(c.ajaxurl,b,function(i){try{result=c.parseJSON(i);if(result.error!==undefined){throw result.error}c.get_unanswered_questions();c.get_messages();c.close_dialog($dialog)}catch(h){c.check_open();c.message(c.settings.strings.error,h);c.unset_busy(d);f.removeAttr("disabled").fadeTo(0,1)}})})}catch(e){c.check_open()}})},this.check_open=function(){var b=jQuery.extend(true,{},this.ajaxoptions);b.type="status";var a=this;$.ajax({cache:false,dataType:"text",method:"get",success:function(c){c=a.parseJSON(c);a.ajaxoptions.ajaxurl=a.ajaxurl;a.settings.status=c;a.init(a.ajaxoptions,a.settings)},url:a.settings.urls.status})},this.close_dialog=function(a){a.empty();a.dialog("close")},this.getQueryParams=function(a){a=a.split("+").join(" ");var d={},c,b=/[?&]?([^=]+)=([^&]*)/g;while(c=b.exec(a)){d[decodeURIComponent(c[1])]=decodeURIComponent(c[2])}return d},this.get_log=function(){var a=this;$.ajax({cache:false,dataType:"html",error:function(){setTimeout(function(){a.get_log()},5000);return},ifModified:true,method:"get",success:function(b){a.settings.$div.html(b)},url:a.settings.urls.log})},this.get_messages=function(){var a=this;$.ajax({cache:false,dataType:"text",ifModified:true,method:"get",statusCode:{404:function(){a.check_open();return},200:function(b){a.settings.tabs.$messages.html(b)}},url:a.settings.urls.messages})},this.get_moderator_guests=function(){var b=jQuery.extend(true,{},this.ajaxoptions);b.type="get_guests";b.last_guest_id=this.settings.moderator.last_guest_id;var a=this;$.post(this.ajaxurl+"?guests",b,function(d){try{result=a.parseJSON(d);$.each(result.guests,function(e,g){var f='<div class="guest"><div class="name">	'+g.name+'</div><div class="invite_button">	<input type="submit" guest_id="'+g.id+'" name="invite['+g.id+']" value="'+a.settings.strings.invite+'" /></div></div>';a.settings.tabs.$moderator.append(f);a.settings.moderator.last_guest_id=Math.max(g.id,a.settings.moderator.last_guest_id)});$(".invite_button input",a.settings.tabs.$moderator).unbind("click");$(".invite_button input",a.settings.tabs.$moderator).click(function(){a.invite_guest($(this).attr("guest_id"))})}catch(c){a.check_open()}})};this.get_unanswered_questions=function(){var b=jQuery.extend(true,{},this.ajaxoptions);b.type="get_unanswered_questions";b.guest_id=this.settings.guest_id;b.nonce_guest=this.settings.nonce_guest;b.hash=this.settings.unanswered_questions.hash;var a=this;$.post(this.ajaxurl,b,function(d){try{result=a.parseJSON(d);if(b.hash!=result.hash){a.settings.tabs.$unanswered_questions.html(result.html);$("table.unanswered_questions tbody tr",a.settings.tabs.$unanswered_questions).click(function(){var e=$(this).attr("question_id");a.answer_question(e)})}}catch(c){a.check_open()}})},this.invite_guest=function(a){var c=jQuery.extend(true,{},this.ajaxoptions);c.type="invite_guest";c.guest_id=a;c.url=window.location.href;var b=this;b.set_busy(b.settings.tabs.$moderator);$(".invite_button input",b.settings.tabs.$moderator).attr("disabled",true).fadeTo(100,0.5);$.post(this.ajaxurl,c,function(e){try{result=b.parseJSON(e);b.unset_busy(b.settings.tabs.$moderator);if(result.email==true){b.message(b.settings.strings.guest_invited,b.settings.strings.the_guest_has_been_invited_you_should_receieve_a_copy_of_the_invitiation)}}catch(d){b.check_open()}finally{$(".invite_button input",b.settings.tabs.$moderator).removeAttr("disabled").fadeTo(100,1)}})};this.init=function(b,c){this.ajaxoptions=$.extend(true,{},b);this.ajaxurl=b.ajaxurl;this.ajaxoptions.ajaxurl=null;this.settings=$.extend(true,this.settings,c);this.settings.guest_id=null;this.settings.div_selector="#sd_qa_"+this.settings.div_id;this.settings.$div=$(this.settings.div_selector);if(this.settings.status===undefined){this.check_open();return}if(this.settings.intervals!==undefined){$.each(this.settings.intervals,function(f,g){clearInterval(g)})}this.settings.intervals={};this.settings.tabs={};var e=this.getQueryParams(document.location.search);var a=(e.guest_id!==undefined);if(a){this.settings.guest_id=e.guest_id;this.settings.guest_key=e.guest_key}var d=this.settings.div_selector;this.set_busy(d);this.settings.$div.html('<div class="loading_qa">'+this.settings.strings.loading_qa+"</div>");if(this.settings.status.closed===true){this.settings.$div.addClass("sd_qa_closed");this.get_log();this.unset_busy(d);return}if(this.settings.status.active!==true){this.settings.$div.remove();this.unset_busy(d);return}this.settings.$div.addClass("sd_qa_open");this.init_tabs();if(a){this.init_guest_login();this.settings.$div.wrapInner('<div class="is_guest" />')}this.init_messages();if(!a){this.init_question();if(this.settings.nonce_moderator==undefined){this.settings.$div.wrapInner('<div class="is_visitor" />')}}if(c.nonce_moderator!==undefined){this.ajaxoptions.nonce_moderator=this.settings.nonce_moderator;this.init_moderator();this.settings.$div.wrapInner('<div class="is_moderator" />')}this.unset_busy(d)},this.init_unanswered_questions=function(){this.settings.unanswered_questions={};this.settings.unanswered_questions.hash=0;this.get_unanswered_questions();var a=this;this.settings.intervals.unanswered_questions=setInterval(function(){a.get_unanswered_questions()},60000)},this.init_guest_login=function(){var b='<div class="">			<p>'+this.settings.strings.to_begin_answering_questions_you_need_to_login_using_your_email_address+"</p>			<p>				<label>					"+this.settings.strings.email_address+'<br />					<input name="guest_email" class="guest_email" type="text" size="40" maxlength="100" />				</label>			</p>			<p><input name="login_guest" class="login_guest" type="submit" value="'+this.settings.strings.login+'" /></p>		</div>';this.settings.tabs.$unanswered_questions=this.add_tab("answer",this.settings.strings.answer_questions,b);$("input.guest_email",this.settings.tabs.$unanswered_questions).focus();var a=this;$("input.login_guest",this.settings.tabs.$unanswered_questions).click(function(){a.set_busy(a.settings.tabs.$unanswered_questions);$("input",a.settings.tabs.$unanswered_questions).attr("disabled",true);var c=jQuery.extend(true,{},a.ajaxoptions);c.type="login_guest";c.guest_id=a.settings.guest_id;c.guest_key=a.settings.guest_key;c.guest_email=$("input.guest_email",a.settings.tabs.$unanswered_questions).val();$.post(a.ajaxurl,c,function(e){try{result=a.parseJSON(e);if(result.error!==undefined){a.message(a.settings.strings.login_failed,result.error);return}if(result.nonce_guest!==undefined){a.settings.tabs.$unanswered_questions.html("");a.settings.nonce_guest=result.nonce_guest;a.init_unanswered_questions()}}catch(d){a.check_open();a.message(a.settings.strings.login_failed,a.settings.strings.please_try_again_in_a_few_moments)}finally{a.unset_busy(a.settings.tabs.$unanswered_questions);$("input",a.settings.tabs.$unanswered_questions).removeAttr("disabled")}})});if($_GET.email!==undefined){$("input.guest_email",this.settings.tabs.$unanswered_questions).val($_GET.email);$("input.login_guest",this.settings.tabs.$unanswered_questions).click()}},this.init_messages=function(){this.settings.tabs.$messages=this.add_tab("messages",this.settings.strings.messages,"");this.settings.messages={};this.settings.messages.hash=0;this.get_messages();var a=this;this.settings.intervals.messages=setInterval(function(){a.get_messages()},15000)},this.init_moderator=function(){this.settings.tabs.$moderator=this.add_tab("moderator",this.settings.strings.moderator,"");this.settings.moderator={};this.settings.moderator.last_guest_id=0;this.get_moderator_guests()},this.init_question=function(){var b=this.settings.user_question_form;this.settings.$div.wrapInner('<div class="use_question_tab_'+(this.settings.use_question_tab?"1":"0")+'" />');if(this.settings.use_question_tab=="1"){this.settings.tabs.$question=this.add_tab("question",this.settings.strings.ask_a_question,b)}else{this.settings.tabs.$question=this.settings.$div.append(b)}var a=this;$("input.submit",this.settings.tabs.$question).click(function(){a.submit_question()})},this.init_tabs=function(){this.settings.$div.html('<div class="sd_qa_tabs"><ul></ul></div>');this.settings.$tabs=$(".sd_qa_tabs",this.settings.div_selector).tabs()},this.message=function(a,b){$("body").css("overflow","hidden");$dialog=$("<div />").dialog({beforeClose:function(){$("body").css("overflow","auto")},height:"auto",modal:true,resizable:false,title:a,}).html(b);$dialog.parent().parent().addClass("sd_qa")};this.parseJSON=function(a){if(a.length<3){throw"No data"}return $.parseJSON(a)};this.set_busy=function(a){return $(a).addClass("busy")},this.submit_question=function(){var b=jQuery.extend(true,{},this.ajaxoptions);var a=this;b.type="submit_question";$.each(["input","textarea"],function(d,f){var e=$(f,a.settings.tabs.$question);$.each(e,function(h,i){var g=$(i);var j=$(i).attr("name");b[j]=g.val()})});a.set_busy(this.settings.tabs.$question);var c=$(".button input",this.settings.tabs.$question);c.attr("disabled",true).blur().fadeTo(100,0.5);$.post(this.ajaxurl,b,function(f){try{var d=$.parseJSON(f);if(d.error!==undefined){a.message(a.settings.strings.error,d.error)}else{a.settings.tabs.$question.addClass("first_question_submitted");$(".clear_after_question_submit",a.settings.tabs.$question).val("");$(".focus_after_question_submit",a.settings.tabs.$question).focus();a.message(a.settings.strings.ok,a.settings.strings.your_message_has_been_sent_to_the_moderators)}}catch(e){a.check_open()}finally{c.fadeTo(0,1).removeAttr("disabled");a.unset_busy(a.settings.tabs.$question)}})},this.unset_busy=function(a){return $(a).removeClass("busy")};(function(q){var m=q.$_GET={},o=q.$_VAN={},n=q.location,i=n.search,v=n.href,r=i.indexOf("?")!=-1?i.indexOf("?")+1:0,u=i.substr(r).split("&"),t=v.replace(/^https?:\/\/(.*?)\//i,"").replace(/\?.*$/i,"").split("/");for(var s in u){var p=u[s].split("=");m[p[0]]=p[1]||null}for(var s in t){o[s]=t[s]||null}})(window)};